generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// --- ENUMS --- (APENAS UMA VEZ CADA)
enum UserRole {
  ADMIN
  GERENTE
  ENGENHEIRO
  COMPRADOR
  PCP
  QUALIDADE
  ESTOQUE
  VENDAS
  USER
}

enum UserDepartment {
  ADMINISTRATIVO
  VENDAS
  ENGENHARIA
  COMPRAS
  PCP
  QUALIDADE
  ESTOQUE
  MONTAGEM
  EXPEDICAO
}

enum OPStatus {
  AGUARDANDO
  EM_ENGENHARIA
  EM_COMPRAS
  EM_FABRICACAO
  EM_AUTOMACAO
  EM_PROJETO_ELETRICO
  EM_CALIBRACAO
  EM_MONTAGEM
  EM_TESTES
  EM_DOCUMENTACAO
  EM_EXPEDICAO
  AGUARDANDO_ENTREGA
  CANCELADA
  CONCLUIDA
}

enum ProcessoStatus {
  NAO_INICIADO
  EM_ANDAMENTO
  AGUARDANDO
  CONCLUIDO
  BLOQUEADO
  CANCELADO
}

enum PecaStatus {
  NAO_INICIADA
  EM_COTACAO
  EM_FABRICACAO
  AGUARDANDO_RECEBIMENTO
  EM_ESTOQUE
  EM_MONTAGEM
  MONTADA
}

enum MovimentacaoTipo {
  ENTRADA
  SAIDA
  AJUSTE
}

enum CompraStatus {
  SOLICITADA
  COTACAO
  APROVADA
  PEDIDO_EMITIDO
  RECEBIDA_PARCIAL
  RECEBIDA_TOTAL
  CANCELADA
}

// --- MODELS ---
model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  password             String
  name                 String
  role                 UserRole              @default(USER)
  department           UserDepartment
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  arquivos             Arquivo[]             @relation("Arquivo_Usuario")
  estoqueMovimentacoes EstoqueMovimentacao[] @relation("EstoqueMovimentacao_Usuario")
  opHistorico          OPHistorico[]         @relation("OPHistorico_Usuario")
  opProcessos          OPProcesso[]          @relation("Processo_Responsavel")
  createdOPs           OP[]                  @relation("OP_CriadaPor")
  responsibleOPs       OP[]                  @relation("OP_Responsavel")
  processoHistorico    ProcessoHistorico[]   @relation("ProcessoHistorico_Usuario")
  configProcessosPadrao ConfigProcessoPadrao[]
  userModules          UserModule[]
  resetToken        String?   @map("reset_token")
  resetTokenExpiry  DateTime? @map("reset_token_expiry")

  @@map("users")
}

model UserModule {
  id        Int     @id @default(autoincrement())
  userId    Int
  moduleId  Int
  canView   Boolean @default(true)    // Alterado de false para true
  canEdit   Boolean @default(false)
  canDelete Boolean @default(false)
  module    Module  @relation(fields: [moduleId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@unique([userId, moduleId])
  @@map("user_modules")
}

model Module {
  id          Int          @id @default(autoincrement())
  nome        String       @unique
  descricao   String?
  icon        String?
  path        String
  isActive    Boolean      @default(true)
  order       Int
  userModules UserModule[]

  @@map("modules")
}

model OP {
  id               Int                   @id @default(autoincrement())
  numeroOP         String                @unique
  codigoMaquina    String
  descricaoMaquina String
  observacoes      String?
  dataPedido       DateTime
  dataEntrega      DateTime
  dataCriacao      DateTime              @default(now())
  dataInicio       DateTime?
  dataFinalizacao  DateTime?
  status           OPStatus              @default(AGUARDANDO)
  progresso        Int                   @default(0)
  cliente          String
  cnpjCliente      String?
  enderecoCliente  String?
  criadoPorId      Int
  responsavelId    Int?
  arquivos         Arquivo[]
  compras          Compra[]
  movimentacoes    EstoqueMovimentacao[]
  historico        OPHistorico[]
  processos        OPProcesso[]
  ordensServico    OrdemServico[]
  criadoPor        User                  @relation("OP_CriadaPor", fields: [criadoPorId], references: [id])
  responsavel      User?                 @relation("OP_Responsavel", fields: [responsavelId], references: [id])
  pecas            Peca[]

  @@map("ops")
}

model OPProcesso {
  id                  Int                 @id @default(autoincrement())
  opId                Int
  nome                String
  descricao           String?
  sequencia           Int
  status              ProcessoStatus      @default(NAO_INICIADO)
  progresso           Int                 @default(0)
  prazoEstimado       Int?                @map("prazo_estimado")
  dataPrevista        DateTime?           @map("data_prevista")
  dataInicioPrevista  DateTime?           @map("data_inicio_prevista")
  dataTerminoPrevista DateTime?           @map("data_termino_prevista")
  dataInicio          DateTime?           @map("data_inicio")
  dataFim             DateTime?           @map("data_fim")
  responsavelId       Int?                @map("responsavel_id")
  vinculoStatusOP     OPStatus?           @map("vinculo_status_op")
  op                  OP                  @relation(fields: [opId], references: [id], onDelete: Cascade)
  responsavel         User?               @relation("Processo_Responsavel", fields: [responsavelId], references: [id])
  historico           ProcessoHistorico[]

  @@map("op_processos")
}

model ProcessoHistorico {
  id         Int        @id @default(autoincrement())
  processoId Int
  usuarioId  Int
  acao       String
  detalhes   String?
  createdAt  DateTime   @default(now())
  processo   OPProcesso @relation(fields: [processoId], references: [id], onDelete: Cascade)
  usuario    User       @relation("ProcessoHistorico_Usuario", fields: [usuarioId], references: [id])

  @@map("processo_historico")
}

model Peca {
  id               Int              @id @default(autoincrement())
  opId             Int
  codigo           String
  descricao        String
  quantidade       Int              @default(1)
  material         String?
  categoria        PecaCategoria    @default(FABRICADO)
  subcategoria     String?
  statusSuprimento SuprimentoStatus @default(NAO_SOLICITADO)
  valorUnitario    Float?           @map("valor_unitario")
  fornecedorId     Int?             @map("fornecedor_id")
  anexos           PecaAnexo[]
  arquivoBOM       String?
  status           PecaStatus       @default(NAO_INICIADA)
  compras          CompraItem[]
  op               OP               @relation(fields: [opId], references: [id], onDelete: Cascade)
  processos        ProcessoPeca[]
  fornecedor       Fornecedor?      @relation(fields: [fornecedorId], references: [id])

  @@unique([opId, codigo])
  @@map("pecas")
}

model PecaAnexo {
  id      Int    @id @default(autoincrement())
  pecaId  Int    @map("peca_id")
  nome    String
  url     String
  peca    Peca   @relation(fields: [pecaId], references: [id], onDelete: Cascade)

  @@map("peca_anexos")
}

model ProcessoPeca {
  id            Int            @id @default(autoincrement())
  pecaId        Int
  osId          Int?           @map("os_id")
  fornecedorId  Int?           @map("fornecedor_id")
  nome          String
  sequencia     Int
  status        ProcessoStatus @default(NAO_INICIADO)
  fornecedorRef Fornecedor?    @relation(fields: [fornecedorId], references: [id])
  tempoEstimado Int?
  peca          Peca           @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  ordemServico  OrdemServico?  @relation(fields: [osId], references: [id])

  @@map("processo_pecas")
}

model OrdemServico {
  id              Int            @id @default(autoincrement())
  numero          String         @unique
  tipo            String         // ex: USINAGEM, PINTURA, SOLDA
  opId            Int            @map("op_id")
  fornecedorId    Int?           @map("fornecedor_id")
  status          ProcessoStatus @default(NAO_INICIADO)
  dataEmissao     DateTime       @default(now()) @map("data_emissao")
  inicioPrevisto  DateTime?      @map("inicio_previsto")
  terminoPrevisto DateTime?      @map("termino_previsto")
  op              OP             @relation(fields: [opId], references: [id], onDelete: Cascade)
  fornecedor      Fornecedor?    @relation(fields: [fornecedorId], references: [id])
  itens           ProcessoPeca[]

  @@map("ordens_servico")
}

model Fornecedor {
  id            Int            @id @default(autoincrement())
  nome          String
  cnpj          String?        @unique
  categorias    String[]       @default([])
  telefone      String?
  whatsapp      String?
  email         String?
  contato       String?
  endereco      String?
  ordensServico OrdemServico[]
  processos     ProcessoPeca[]
  pecas         Peca[]

  @@map("fornecedores")
}

model Estoque {
  id            Int                   @id @default(autoincrement())
  codigo        String                @unique
  descricao     String
  categoria     String
  quantidade    Int                   @default(0)
  unidade       String                @default("UN")
  minEstoque    Int                   @default(0)
  localizacao   String?
  movimentacoes EstoqueMovimentacao[]

  @@map("estoque")
}

model EstoqueMovimentacao {
  id         Int              @id @default(autoincrement())
  estoqueId  Int
  tipo       MovimentacaoTipo
  quantidade Int
  motivo     String
  opId       Int?
  usuarioId  Int
  createdAt  DateTime         @default(now())
  estoque    Estoque          @relation(fields: [estoqueId], references: [id])
  op         OP?              @relation(fields: [opId], references: [id], onDelete: Cascade)
  usuario    User             @relation("EstoqueMovimentacao_Usuario", fields: [usuarioId], references: [id])

  @@map("estoque_movimentacoes")
}

model Compra {
  id                  Int          @id @default(autoincrement())
  opId                Int
  numero              String       @unique
  fornecedor          String
  valorTotal          Float?
  status              CompraStatus @default(SOLICITADA)
  dataSolicitacao     DateTime     @default(now())
  dataEntregaPrevista DateTime?
  itens               CompraItem[]
  op                  OP           @relation(fields: [opId], references: [id], onDelete: Cascade)

  @@map("compras")
}

model CompraItem {
  id            Int    @id @default(autoincrement())
  compraId      Int
  pecaId        Int?
  descricao     String
  quantidade    Int
  valorUnitario Float
  compra        Compra @relation(fields: [compraId], references: [id])
  peca          Peca?  @relation(fields: [pecaId], references: [id], onDelete: SetNull)

  @@map("compra_itens")
}

model OPHistorico {
  id        Int      @id @default(autoincrement())
  opId      Int
  usuarioId Int
  acao      String
  detalhes  String?
  createdAt DateTime @default(now())
  op        OP       @relation(fields: [opId], references: [id], onDelete: Cascade)
  usuario   User     @relation("OPHistorico_Usuario", fields: [usuarioId], references: [id])

  @@map("op_historico")
}

model Arquivo {
  id        Int      @id @default(autoincrement())
  opId      Int?
  nome      String
  tipo      String
  url       String
  tamanho   Int
  usuarioId Int
  createdAt DateTime @default(now())
  op        OP?      @relation(fields: [opId], references: [id], onDelete: Cascade)
  usuario   User     @relation("Arquivo_Usuario", fields: [usuarioId], references: [id])

  @@map("arquivos")
}

enum PecaCategoria {
  COMPRADO
  FABRICADO
}

enum SuprimentoStatus {
  NAO_SOLICITADO
  EM_ORCAMENTO
  COMPRADO
  RECEBIDO
}

// Modelos de Configuração e Padronização
model ConfigCategoriaFornecedor {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?

  @@map("config_categorias_fornecedor")
}

model ConfigProcessoPadrao {
  id                  Int                    @id @default(autoincrement())
  nome                String                 @unique
  descricao           String?
  prazoEstimadoPadrao Int?                   @map("prazo_estimado_padrao")
  responsavelId       Int?                   @map("responsavel_id")
  vinculoStatusOP     OPStatus?              @map("vinculo_status_op")
  responsavel         User?                  @relation(fields: [responsavelId], references: [id])
  itens               ConfigTemplateOPItem[]

  @@map("config_processos_padrao")
}

model ConfigProcessoPeca {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?

  @@map("config_processos_peca")
}

model ConfigTemplateOP {
  id        Int                    @id @default(autoincrement())
  nome      String                 @unique
  processos ConfigTemplateOPItem[]

  @@map("config_templates_op")
}

model ConfigTemplateOPItem {
  id         Int                  @id @default(autoincrement())
  templateId Int                  @map("template_id")
  processoId Int                  @map("processo_id")
  sequencia  Int
  template   ConfigTemplateOP     @relation(fields: [templateId], references: [id], onDelete: Cascade)
  processo   ConfigProcessoPadrao @relation(fields: [processoId], references: [id])

  @@map("config_template_op_itens")
}